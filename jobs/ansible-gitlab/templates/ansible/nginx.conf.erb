worker_processes  1;
error_log /var/vcap/sys/log/nginx/error.log   info;
#pid        logs/nginx.pid; # PIDFILE is configured via monit's ctl
events {
  worker_connections  1024;
}
http {
  include /var/vcap/packages/nginx/conf/mime.types;
  default_type  application/octet-stream;
  sendfile        on;
  ssi on;
  keepalive_timeout  65;
  server_names_hash_bucket_size 64;
  server {
    listen                *:8080 ;
    access_log            /var/vcap/sys/log/nginx/oss-logsearch.access.log;
    location / {

    <%
    backend_servers = []
    backend_port = nil
    if_link("http_backend") do |backend|
      backend_servers = backend.instances.map(&:address)
    end
    %>
    <% backend_servers.each_with_index do |ip, index| -%>
      proxy_pass http://<%= ip %>:8080;
    <% end %>

      proxy_read_timeout 90;
    }
    real_ip_header X-Forwarded-For;
    real_ip_recursive  on;
  }
  root /var/vcap/store/nginx;
  index index.shtml index.html index.htm;
}
